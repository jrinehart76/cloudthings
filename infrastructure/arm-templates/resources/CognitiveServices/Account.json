{
  "$schema": "https://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "locationAbv": {
      "type": "string",
      "defaultValue": "eus",
      "metadata": {
        "description": "The shorter version of the deployment region. E.G. uksouth, seasia"
      }
    },
    "sku": {
      "type": "string",
      "defaultValue": "F0",
      "allowedValues": [
        "F0",
        "P0",
        "P1",
        "P2",
        "S0",
        "S1",
        "S2",
        "S3",
        "S4",
        "S5",
        "S6"
      ],
      "metadata": {
        "description": "The sku of the Cognitive Service"
      }
    },
    "serviceKind": {
      "type": "string",
      "defaultValue": "ComputerVision",
      "allowedValues": [
        "Academic",
        "Bing.Autosuggest",
        "Bing.Autosuggest.v7",
        "Bing.CustomSearch",
        "Bing.Search",
        "Bing.Search.v7",
        "Bing.Speech",
        "Bing.SpellCheck",
        "Bing.SpellCheck.v7",
        "ComputerVision",
        "ContentModerator",
        "CustomSpeech",
        "Emotion",
        "Face",
        "LUIS",
        "Recommendations",
        "SpeakerRecognition",
        "Speech",
        "SpeechTranslation",
        "TextAnalytics",
        "TextTranslation",
        "WebLM"
      ],
      "metadata": {
        "description": "The sku of the Cognitive Service"
      }
    },
    "numberOfInstances": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "The number of instances per plan"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "EastUS",
      "metadata": {
        "description": "The Azure region for this deployment"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "Dev",
      "metadata": {
        "description": "The abbreviated environment label"
      }
    },
    "application": {
      "type": "string",
      "defaultValue": "APP",
      "metadata": {
        "description": "The abbreviated application name"
      }
    },
    "region": {
      "type": "string",
      "defaultValue": "AM",
      "metadata": {
        "description": "The abbreviated Azure Region code"
      }
    },
    "settingName": {
      "type": "string",
      "defaultValue": "logAnalyticsService",
      "metadata": {
        "description": "Name of the setting. Name for the diagnostic setting resource. Eg. 'archiveToStorage' or 'forSecurityTeam'."
      }
    },
    "workspaceName": {
      "type": "string",
      "allowedValues": [
        "laws-am-eastus",
        "laws-ap-southeastasia",
        "laws-eu-uksouth",
        "la-am-eastus-devopspoc",
        "la-cn-chinaeast2-nonprod",
        "la-cn-chinaeast2-prod"
      ],
      "metadata": {
        "description": "Log Analytics workspace ID for the Log Analytics workspace to which logs will be sent."
      }
    },
    "laResourceGroup": {
      "type": "string",
      "allowedValues": [
        "rg-am-eastus",
        "rg-ap-southeastasia",
        "rg-eu-uksouth",
        "rg-am-eastus-devopspoc-mgmt",
        "RG-CN-ChinaEast2-NonProd-Mgmt",
        "RG-CN-ChinaEast2-Prod-Mgmt"
      ],
      "metadata": {
        "description": "The Resource Group where the Log Analytics workspace resides to which logs will be sent."
      }
    }
  },
  "variables": {
    "name": "[tolower(concat('cog', '-', parameters('region'), '-', parameters('locationAbv'), '-', parameters('environment'), '-', parameters('application'), '-'))]",
    "nonChinaWorkspaceID": "[resourceId('0ffde392-0ea6-4c28-b315-92e6417ab377', parameters('laResourceGroup'), 'Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]",
    "chinaWorkspaceID": "[resourceId(parameters('laResourceGroup'), 'Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
  },
  "resources": [
    {
      "name": "[concat(variables('name'), padleft(copyIndex(1), 4, '0'))]",
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2017-04-18",
      "sku": {
        "name": "[parameters('sku')]"
      },
      "kind": "[parameters('serviceKind')]",
      "location": "[parameters('location')]",
      "copy": {
        "name": "accCopy",
        "count": "[parameters('numberOfInstances')]"
      },
      "properties": {},
      "resources": [
        {
          "type": "providers/diagnosticSettings",
          "name": "Microsoft.Insights/10mdiagnosticsettings",
          "dependsOn": [
            "[concat(variables('name'), padleft(copyIndex(1), 4, '0'))]"
          ],
          "apiVersion": "2017-05-01-preview",
          "properties": {
            "name": "[parameters('settingName')]",
            "workspaceId": "[if(equals(tolower(parameters('location')), 'chinaeast2'), variables('chinaWorkspaceID'), variables('nonChinaWorkspaceID'))]",
            "logs": [
              {
                "category": "Audit",
                "enabled": true,
                "retentionPolicy": {
                  "days": 90,
                  "enabled": true
                }
              },
              {
                "category": "RequestResponse",
                "enabled": true,
                "retentionPolicy": {
                  "days": 90,
                  "enabled": true
                }
              }
            ]
          }
        }
      ]
    }
  ]
}