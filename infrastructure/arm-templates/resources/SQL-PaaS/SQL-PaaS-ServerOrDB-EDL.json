{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"collation": {
			"type": "string",
			"defaultValue": "SQL_Latin1_General_CP1_CI_AS",
			"metadata": {
				"description": "sql collation"
			}
		},
		"dbSku": {
			"type": "string",
			"defaultValue": "S3",
			"metadata": {
				"description": "database sku"
			}
		},
		"dbTier": {
			"type": "string",
			"defaultValue": "Standard",
			"metadata": {
				"description": "database sku"
			}
		},
		"maxSizeBytes": {
			"type": "int"
		},
		"existingVAStorageAccount": {
			"type": "string",
			"defaultValue": "no",
			"metadata": {
				"description": "Is there an existing storage account for vulnerability assessment logs. yes/no"
			},
			"allowedValues": [
				"no",
				"yes"
			]
		},
		"existingSQLServer": {
			"type": "string",
			"defaultValue": "no",
			"metadata": {
				"description": "Is there an existing sql server. yes/no"
			},
			"allowedValues": [
				"no",
				"yes"
			]
		},
		"location": {
			"type": "string",
			"defaultValue": "EastUS",
			"metadata": {
				"description": "The Azure region for this deployment"
			}
		},
		"environment": {
			"type": "string",
			"defaultValue": "Dev",
			"metadata": {
				"description": "The abbreviated environment label"
			}
		},
		"application": {
			"type": "string",
			"defaultValue": "APP",
			"metadata": {
				"description": "The abbreviated application name"
			}
		},
		"adminLogin": {
			"type": "string",
			"minLength": 1,
			"maxLength": 16
		},
		"adminPassword": {
			"type": "securestring"
		},
		"vnetRuleName": {
			"type": "string",
			"minLength": 1,
			"maxLength": 128,
			"defaultValue": "VNET-AM-EastUS-Prod-SS"
		},
		"region": {
			"type": "string",
			"defaultValue": "AM",
			"metadata": {
				"description": "The abbreviated Azure Region code"
			}
		},
		"locationAbv": {
			"type": "string",
			"defaultValue": "eus",
			"metadata": {
				"description": "The shorter version of the deployment region. E.G. uks, seas"
			}
		},
		"purpose": {
			"type": "string",
			"defaultValue": "data",
			"metadata": {
				"description": "purpose or use of the database. Ie data, mdm, backup"
			}
		},
		"sharedServiceSubnetResourceID": {
			"type": "string",
			"defaultValue": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rg-region1-Prod-SS/providers/Microsoft.Network/virtualNetworks/VNET-AM-EastUS-Prod-SS/subnets/Subnet-AM-EastUS-Prod-SS-PANUnTrust",
			"metadata": {
				"description": "Range of allowed IPs to access cosmosdb"
			}
		},
		"sqlAdminAadGroupId": {
			"type": "securestring"
		},
		"sqlAdminAadGroup": {
			"type": "string"
		}
	},
	"variables": {
		"storageAccountName": "[tolower(concat('sa', parameters('region'), parameters('locationAbv'), parameters('environment'), parameters('application'), 'va'))]",
		"baseNamingPrefix": "[concat(parameters('region'), '-',  parameters('location'), '-', parameters('environment'), '-', parameters('application'))]",
		"sqlDBName": "[concat('DB', '_', parameters('purpose'))]",
		"sqlServerName": "[tolower(concat('sql', '-',variables('baseNamingPrefix')))]",
		"enableVA": true
	},
	"resources": [{
			"condition": "[equals(parameters('existingSQLServer'), 'no')]",
			"type": "Microsoft.Sql/servers",
			"kind": "v12.0",
			"name": "[variables('sqlServerName')]",
			"apiVersion": "2021-11-01",
			"location": "[resourceGroup().location]",
			"scale": null,
			"properties": {
				"administratorLogin": "[parameters('adminLogin')]",
				"administratorLoginPassword": "[parameters('adminPassword')]",
				"version": "12.0"
			},
			"resources": [{
				"name": "ActiveDirectory",
				"type": "administrators",
				"apiVersion": "2021-11-01",
				"dependsOn": [
					"[concat('Microsoft.Sql/servers/', variables('sqlServerName'))]",
					"[concat('Microsoft.Sql/servers/', variables('sqlServerName'), '/databases/',variables('sqlDBName'))]"
				],
				"location": "[parameters('location')]",
				"properties": {
					"administratorType": "ActiveDirectory",
					"login": "[parameters('sqlAdminAadGroup')]",
					"sid": "[parameters('sqlAdminAadGroupId')]",
					"tenantId": "[subscription().tenantId]"
				}
			}]
		},
		{
			"condition": "[equals(parameters('existingSQLServer'), 'no')]",
			"type": "Microsoft.Sql/servers/virtualNetworkRules",
			"apiVersion": "2021-11-01",
			"dependsOn": [
				"[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
			],
			"name": "[concat(variables('sqlServerName'), '/', parameters('vnetRuleName'))]",
			"properties": {
				"ignoreMissingVnetServiceEndpoint": true,
				"virtualNetworkSubnetId": "[parameters('sharedServiceSubnetResourceID')]"
			}
		},
		{
			"condition": "[equals(parameters('existingVAStorageAccount'), 'no')]",
			"apiVersion": "2018-07-01",
			"dependsOn": [],
			"kind": "StorageV2",
			"location": "[parameters('location')]",
			"name": "[variables('storageAccountName')]",
			"properties": {
				"supportsHttpsTrafficOnly": true
			},
			"sku": {
				"name": "Standard_LRS"
			},
			"type": "Microsoft.Storage/storageAccounts",
			"resources": [{
				"name": "default/vulnerability-assessment",
				"type": "blobServices/containers",
				"apiVersion": "2018-07-01",
				"dependsOn": [
					"[variables('storageAccountName')]"
				]
			}]
		},
		{
			"type": "Microsoft.Sql/servers/databases",
			"apiVersion": "2021-11-01",
			"location": "[parameters('location')]",
			"name": "[concat(variables('sqlServerName'), '/', variables('sqlDBName'))]",
			"dependsOn": [
				"[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
			],
			"properties": {
				"collation": "[parameters('collation')]",
				"maxSizeBytes": "[parameters('maxSizeBytes')]"
			},
			"sku": {
				"name": "[parameters('dbSku')]",
				"tier": "[parameters('dbTier')]"
			}
		},
		{
			"apiVersion": "2021-11-01",
			"type": "Microsoft.Sql/servers/securityAlertPolicies",
			"name": "[concat(variables('sqlServerName'), '/Default')]",
			"dependsOn": [
				"[concat('Microsoft.Sql/servers/', variables('sqlServerName'), '/databases/', variables('sqlDBName'))]"
			],
			"properties": {
				"state": "Enabled",
				"disabledAlerts": [],
				"emailAddresses": ["admin@customer-a.com"],
				"emailAccountAdmins": false
			}
		},
		{
			"condition": "[variables('enableVA')]",
			"apiVersion": "2021-11-01",
			"type": "Microsoft.Sql/servers/vulnerabilityAssessments",
			"name": "[concat(variables('sqlServerName'), '/Default')]",
			"properties": {
				"storageContainerPath": "[if(variables('enableVA'), concat(reference(variables('storageAccountName'), '2018-02-01').primaryEndpoints.blob, 'vulnerability-assessment'), '')]",
				"storageAccountAccessKey": "[if(variables('enableVA'), listKeys(variables('storageAccountName'), '2018-02-01').keys[0].value, '')]",
				"recurringScans": {
					"isEnabled": true,
					"emailSubscriptionAdmins": true,
					"emails": []
				},
				"retentionDays": 7,
				"auditActionsAndGroups": ["SUCCESSFUL_DATABASE_AUTHENTICATION_GROUP", "DATABASE_LOGOUT_GROUP", "USER_CHANGE_PASSWORD_GROUP"],
				"storageAccountSubscriptionId": "[subscription().subscriptionId]"
			},
			"dependsOn": [
				"[concat('Microsoft.Sql/servers/', variables('sqlServerName'), '/databases/', variables('sqlDBName'))]",
				"[concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]",
				"[concat('Microsoft.Sql/servers/', variables('sqlServerName'), '/securityAlertPolicies/Default')]"
			]
		}
	]
}