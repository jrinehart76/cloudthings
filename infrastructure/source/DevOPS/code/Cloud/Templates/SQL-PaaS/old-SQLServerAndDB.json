{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "adminLogin": {
      "type": "string",
      "minLength": 1,
      "maxLength": 16
    },
    "adminPassword": {
      "type": "securestring"
    },
    "vnetRuleName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 128,
      "defaultValue": "VNET-AM-EastUS-Prod-SS"
    },
    "sharedServiceSubnetResourceID": {
      "type": "string",
      "defaultValue": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rg-region1-Prod-SS/providers/Microsoft.Network/virtualNetworks/VNET-AM-EastUS-Prod-SS/subnets/Subnet-AM-EastUS-Prod-SS-PANUnTrust",
      "metadata": {
        "description": "Range of allowed IPs to access cosmosdb"
      }
    },
    "dbSku": {
      "type": "string",
      "defaultValue": "S3",
      "metadata": {
        "description": "database sku"
      }
    },
    "dbTier": {
      "type": "string",
      "defaultValue": "Standard",
      "metadata": {
        "description": "database sku"
      }
    },
    "collation": {
      "type": "string",
      "defaultValue": "SQL_Latin1_General_CP1_CI_AS",
      "metadata": {
        "description": "sql collation"
      }
    },
    "dbSizeInBytes": {
      "type": "string",
      "defaultValue": "1099511627776",
      "metadata": {
        "description": "DB size in bytes (default value 1 TB)"
      }
    },
    "allowAzureIPs": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Allow DB to communicate to azure services"
      }
    },
    "enableATP": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Azure Alert Policies"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "EastUS",
      "metadata": {
        "description": "The Azure region for this deployment"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "Dev",
      "metadata": {
        "description": "The abbreviated environment label"
      }
    },
    "application": {
      "type": "string",
      "defaultValue": "APP",
      "metadata": {
        "description": "The abbreviated application name"
      }
    },
    "region": {
      "type": "string",
      "defaultValue": "AM",
      "metadata": {
        "description": "The abbreviated Azure Region code"
      }
    },
    "settingName": {
      "type": "string",
      "defaultValue": "logAnalyticsService",
      "metadata": {
        "description": "Name of the setting. Name for the diagnostic setting resource. Eg. 'archiveToStorage' or 'forSecurityTeam'."
      }
    },
    "workspaceName": {
      "type": "string",
      "allowedValues": [
        "la-am-eastus-NonProd-PaaS",
        "la-am-eastus-prod-paas",
        "la-ap-southeastasia-nonprod-v2",
        "la-ap-southeastasia-prod-v2",
        "la-eu-uksouth-nonprod-v2",
        "la-eu-uksouth-prod-v2",
        "la-am-eastus-devopspoc",
        "la-am-eastus-NonProd-CEPLATAM"

      ],
      "metadata": {
        "description": "Log Analytics workspace ID for the Log Analytics workspace to which logs will be sent."
      }
    },
    "laResourceGroup": {
      "type": "string",
      "defaultValue": "rg-region1-DevOpsPOC-Mgmt",
      "allowedValues": [
        "rg-region1-MYELX-Mgmt",
        "rg-region1-NonProd-PaaS-Mgmt",
        "rg-region1-Prod-PaaS-Mgmt",
        "rg-region2-SoutheastAsia-NONPROD-V2-Mgmt",
        "rg-region2-SoutheastAsia-Prod-V2-MGMT",
        "rg-region3-UKSouth-NonProd-V2-MGMT",
        "rg-region3-UKSouth-Prod-V2-MGMT",
        "rg-region1-DevOpsPOC-Mgmt",
        "rg-region1-NonProd-CEPLATAM-Mgmt"
      ],
      "metadata": {
        "description": "The Resource Group where the Log Analytics workspace resides to which logs will be sent."
      }
    }
  },
  "variables": {
    "baseNamingPrefix": "[concat(parameters('region'), '-',  parameters('location'), '-', parameters('environment'), '-', parameters('application'))]",
    "enabledForDeployment": "True",
    "enabledForTemplateDeployment": "True",
    "tenantId": "[subscription().subscriptionId]",
    "sqlServerName": "[tolower(concat('sql', '-',variables('baseNamingPrefix')))]",
    "sqlDBName": "[tolower(concat('DB', '-',variables('baseNamingPrefix')))]",
    "keysName": "[concat('keys', variables('sqlServerName'))]",
    "workspaceId": "[resourceId(parameters('laResourceGroup'), 'Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Sql/servers",
      "kind": "v12.0",
      "name": "[variables('sqlServerName')]",
      "apiVersion": "2015-05-01-preview",
      "location": "[resourceGroup().location]",
      "scale": null,
      "properties": {
        "administratorLogin": "[parameters('adminLogin')]",
        "administratorLoginPassword": "[parameters('adminPassword')]",
        "version": "12.0"
      },
      "resources": [
        {
          "apiVersion": "2017-10-01-preview",
          "dependsOn": [
            "[concat('Microsoft.Sql/servers/', variables('sqlServerName'))]"
          ],
          "location": "[parameters('location')]",
          "name": "[variables('sqlDBName')]",
          "properties": {
            "collation": "[parameters('collation')]",
            "maxSizeBytes": "[parameters('dbSizeInBytes')]"
          },
          "resources": [
            {
              "type": "providers/diagnosticSettings",
              "name": "Microsoft.Insights/diagnostics",
              "dependsOn": [
                "[variables('sqlDBName')]"
              ],
              "apiVersion": "2017-05-01-preview",
              "properties": {
                "name": "[parameters('settingName')]",
                "workspaceId": "[variables('workspaceId')]",
                "logs": [
                  {
                    "category": "SQLInsights",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  },
                  {
                    "category": "AutomaticTuning",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  },
                  {
                    "category": "QueryStoreRuntimeStatistics",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  },
                  {
                    "category": "QueryStoreWaitStatistics",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  },
                  {
                    "category": "Errors",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  },
                  {
                    "category": "DatabaseWaitStatistics",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  },
                  {
                    "category": "Timeouts",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  },
                  {
                    "category": "Blocks",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  },
                  {
                    "category": "Deadlocks",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  },
                  {
                    "category": "Audit",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  },
                  {
                    "category": "SQLSecurityAuditEvents",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  }
                ],
                "metrics":[
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  }
                ]
              }
            }
          ],    
          "sku": {
            "name": "[parameters('dbSku')]",
            "tier": "[parameters('dbTier')]"
          },
          "type": "databases"
        },
        {
          "condition": "[parameters('allowAzureIps')]",
          "apiVersion": "2014-04-01-preview",
          "dependsOn": [
            "[concat('Microsoft.Sql/servers/', variables('sqlServerName'))]"
          ],
          "location": "[parameters('location')]",
          "name": "AllowAllWindowsAzureIps",
          "properties": {
            "endIpAddress": "0.0.0.0",
            "startIpAddress": "0.0.0.0"
          },
          "type": "firewallrules"
        },
        {
          "condition": "[parameters('enableATP')]",
          "apiVersion": "2017-03-01-preview",
          "type": "securityAlertPolicies",
          "name": "Default",
          "dependsOn": [
            "[concat('Microsoft.Sql/servers/', variables('sqlServerName'))]",
            "[concat('Microsoft.Sql/servers/', variables('sqlServerName'), '/databases/', variables('sqlDBName'))]"
          ],
          "properties": {
            "state": "Enabled",
            "disabledAlerts": [],
            "emailAddresses": [],
            "emailAccountAdmins": true
          }
        }
      ]
    },
    {
      "type": "Microsoft.Sql/servers/virtualNetworkRules",
      "apiVersion": "2015-05-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
      ],
      "name": "[concat(variables('sqlServerName'), '/', parameters('vnetRuleName'))]",
      "properties": {
        "ignoreMissingVnetServiceEndpoint": true,
        "virtualNetworkSubnetId": "[parameters('sharedServiceSubnetResourceID')]"
      }
    }
  ]
}
