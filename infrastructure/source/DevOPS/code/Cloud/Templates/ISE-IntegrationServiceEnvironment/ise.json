{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "defaultValue": "[resourceGroup().location]",
      "type": "string",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "integrationServiceEnvironmentSku": {
      "type": "string",
      "defaultValue": "Developer",
      "allowedValues": [ "Developer", "Premium" ],
      "metadata": {
        "description": "The SKU for the Integration Service Environment, either Developer or Premium."
      }
    },
    "skuCapacity": {
      "defaultValue": 0,
      "type": "int",
      "metadata": {
        "description": "The number of scale units for the Integration Service Environment. 0 is the base unit."
      }
    },
    "managedConnectors": {
      "type": "array",
      "metadata": {
        "description": "The list of managed connectors to deploy into the ISE in JSON array format (e.g. [\"sql\", \"ftp\" ...]). The values must be from this list: sql;ftp;azureblob;azurefile;azurequeues;azuretables;sftpwithssh;edifact;x12;servicebus;documentdb;eventhubs;mq;sqldw;db2;smtp;si3270"
      },
      "defaultValue": [ "sql", "ftp", "azureblob", "azurefile", "azurequeues", "azuretables", "sftpwithssh", "edifact", "x12", "servicebus", "documentdb", "eventhub", "mq", "sqldw", "db2", "smtp", "si3270" ]
    },
    "subnet1Name": {
      "type": "string",
      "defaultValue": "Subnet1",
      "metadata": {
        "description": "The name of the first ISE subnet."
      }
    },
    "subnet2Name": {
      "type": "string",
      "defaultValue": "Subnet2",
      "metadata": {
        "description": "The name of the second ISE subnet."
      }
    },
    "subnet3Name": {
      "type": "string",
      "defaultValue": "Subnet3",
      "metadata": {
        "description": "The name of the third ISE subnet."
      }
    },
    "subnet4Name": {
      "type": "string",
      "defaultValue": "Subnet4",
      "metadata": {
        "description": "The name of the fourth ISE subnet."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "EastUS",
      "metadata": {
        "description": "The Azure region for this deployment"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "Dev",
      "metadata": {
        "description": "The abbreviated environment label"
      }
    },
    "application": {
      "type": "string",
      "defaultValue": "APP",
      "metadata": {
        "description": "The abbreviated application name"
      }
    },
    "region": {
      "type": "string",
      "defaultValue": "AM",
      "metadata": {
        "description": "The abbreviated Azure Region code"
      }
    },
    "virtualNetworkName": {
      "type": "string",
      "metadata": {
        "description": "The name of the existing virtual network into which the App Service Environment will be deployed"
      }
    },

    "VNetResourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "The name of the existing resource group of the virtual network into which the App Service Environment will be deployed"
      }
    }
  },
  "variables": {
    "vnetId": "[resourceId(parameters('VNetResourceGroupName'),'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
    "namingSuffix": "[concat(parameters('region'), '-', parameters('location'), '-', parameters('environment'), '-', parameters('application'))]",
    "iseName": "[concat('ISE-', variables('namingSuffix'))]"
  },

  "resources": [
    {
      "type": "Microsoft.Logic/integrationServiceEnvironments",
      "apiVersion": "2019-05-01",
      "name": "[variables('iseName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
      ],
      "sku": {
        "name": "[parameters('integrationServiceEnvironmentSku')]",
        "capacity": "[parameters('skuCapacity')]"
      },
      "properties": {
        "networkConfiguration": {
          "subnets": [
            {
              "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnet1Name'))]"
            },
            {
              "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnet2Name'))]"
            },
            {
              "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnet3Name'))]"
            },
            {
              "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnet4Name'))]"
            }
          ]
        }
      }
    },
    {
      "apiVersion": "2019-05-01",
      "type": "Microsoft.Logic/integrationServiceEnvironments/ManagedApis",
      "name": "[concat(variables('iseName'), '/', parameters('managedConnectors')[copyindex()])]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[concat('Microsoft.Logic/integrationServiceEnvironments/', variables('iseName'))]"
      ],
      "copy": {
        "name": "queueCopy",
        "count": "[length(parameters('managedConnectors'))]"
      },
      "properties": {
      }
    }
  ]
}