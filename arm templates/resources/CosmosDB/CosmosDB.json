{
  "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "accountType": {
      "type": "string",
      "defaultValue": "GlobalDocumentDB",
      "metadata": {
        "description": "Type of CosmosDB Account. GlobalDocumentDB includes SQL, AzureTable, Gremlin."
      },
      "allowedValues": [
        "GlobalDocumentDB",
        "MongoDB"
      ]
    },
    "secondaryRegionNeeded":{
      "type": "string",
      "defaultValue": "No",
      "allowedValues": [
        "No",
        "Yes"
      ],
      "metadata": {
        "description":"Flag for adding a secondary region"
      }
    },
    "pairedLocation": {
      "type": "string",
      "defaultValue": "WestUS",
      "metadata": {
        "description":"Secondary region if 'secondaryRegionNeeded' is Yes"
      }
    },

    "ipRangeFilter": {
      "type": "string",
      "defaultValue": "104.42.195.92,40.76.54.131,52.176.6.30,52.169.50.45,52.187.184.26",
      "metadata": {
        "description": "Range of allowed IPs to access cosmosdb. Default Value Ips required for portal access."
      }
    },
    "sharedServiceSubnetResourceID": {
      "type": "string",
      "defaultValue": "/subscriptions/8a00b99b-04e8-474d-a318-397385dc07a4/resourceGroups/RG-AM-EastUS-Prod-SS/providers/Microsoft.Network/virtualNetworks/VNET-AM-EastUS-Prod-SS/subnets/Subnet-AM-EastUS-Prod-SS-PANUnTrust",
      "metadata": {
        "description": "Range of allowed IPs to access cosmosdb"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "EastUS",
      "metadata": {
        "description": "The Azure region for this deployment"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "Dev",
      "metadata": {
        "description": "The abbreviated environment label"
      }
    },
    "application": {
      "type": "string",
      "defaultValue": "APP",
      "metadata": {
        "description": "The abbreviated application name"
      }
    },
    "region": {
      "type": "string",
      "defaultValue": "AM",
      "metadata": {
        "description": "The abbreviated Azure Region code"
      }
    },
    "settingName": {
      "type": "string",
      "defaultValue": "logAnalyticsService",
      "metadata": {
        "description": "Name of the setting. Name for the diagnostic setting resource. Eg. 'archiveToStorage' or 'forSecurityTeam'."
      }
    },
    "workspaceName": {
      "type": "string",
      "allowedValues": [
        "laws-am-eastus",
        "laws-ap-southeastasia",
        "laws-eu-uksouth",
        "la-am-eastus-devopspoc",
        "la-cn-chinaeast2-nonprod",
        "la-cn-chinaeast2-prod"
      ],
      "metadata": {
        "description": "Log Analytics workspace ID for the Log Analytics workspace to which logs will be sent."
      }
    },
    "laResourceGroup": {
      "type": "string",
      "allowedValues": [
        "rg-am-eastus",
        "rg-ap-southeastasia",
        "rg-eu-uksouth",
        "rg-am-eastus-devopspoc-mgmt",
        "RG-CN-ChinaEast2-NonProd-Mgmt",
        "RG-CN-ChinaEast2-Prod-Mgmt"
      ],
      "metadata": {
        "description": "The Resource Group where the Log Analytics workspace resides to which logs will be sent."
      }
    }
  },
  "variables": {
    "baseNamingPrefix": "[concat(parameters('region'), '-',  parameters('location'), '-', parameters('environment'), '-', parameters('application'))]",
    "cosmosDBAcctName": "[tolower(concat('cosdb-', variables('baseNamingPrefix')))]",
    "pairedLocation": "[toLower(parameters('pairedLocation'))]",
    "locationsSingleRegion": [{"failoverPriority":0,"locationName":"[parameters('location')]"}],
    "locationsDoubleRegion": [{"failoverPriority":0,"locationName":"[parameters('location')]"},{"failoverPriority":1,"locationName":"[variables('pairedLocation')]"}],
    "nonChinaWorkspaceID": "[resourceId('0ffde392-0ea6-4c28-b315-92e6417ab377', parameters('laResourceGroup'), 'Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]",
    "chinaWorkspaceID": "[resourceId(parameters('laResourceGroup'), 'Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
  },
  "resources": [
    {
      "apiVersion": "2015-04-08",
      "kind": "[parameters('accountType')]",
      "type": "Microsoft.DocumentDB/databaseAccounts",
      "name": "[variables('cosmosDBAcctName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
      ],
      "properties": {
        "databaseAccountOfferType": "Standard",
        "ipRangeFilter": "[parameters('ipRangeFilter')]",
        "locations": "[if(equals(parameters('secondaryRegionNeeded'), 'Yes'),variables('locationsDoubleRegion'),variables('locationsSingleRegion'))]",
        "isVirtualNetworkFilterEnabled": true,
        "virtualNetworkRules": [
          {
            "id": "[parameters('sharedServiceSubnetResourceID')]"
          }
        ]
      },
      "resources": [
        {
          "type": "providers/diagnosticSettings",
          "name": "Microsoft.Insights/10mdiagnosticsettings",
          "dependsOn": [
            "[variables('cosmosDBAcctName')]"
          ],
          "apiVersion": "2017-05-01-preview",
          "properties": {
            "name": "[variables('cosmosDBAcctName')]",
            "workspaceId": "[if(equals(tolower(parameters('location')), 'chinaeast2'), variables('chinaWorkspaceID'), variables('nonChinaWorkspaceID'))]",
            "logs": [
              {
                "category": "DataPlaneRequests",
                "enabled": true,
                "retentionPolicy": {
                  "days": 90,
                  "enabled": true
                }
              },
              {
                "category": "MongoRequests",
                "enabled": true,
                "retentionPolicy": {
                  "days": 90,
                  "enabled": true
                }
              },
              {
                "category": "QueryRuntimeStatistics",
                "enabled": true,
                "retentionPolicy": {
                  "days": 90,
                  "enabled": true
                }
              }
            ]
          }
        }
      ]
    }
  ],
  "outputs": {
    "test":{
      "type": "string",
      "value": "Hi"
    },
    "locationValue":{
      "type": "array",
      "value": "[if(equals(parameters('secondaryRegionNeeded'), 'Yes'),variables('locationsDoubleRegion'),variables('locationsSingleRegion'))]"
    }
  }
}