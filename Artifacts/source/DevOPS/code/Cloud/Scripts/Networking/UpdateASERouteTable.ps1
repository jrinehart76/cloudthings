##################################################################################
#   Adds Management IPs for App service environment to an existing route table.  #
##################################################################################

param (
    [parameter(Mandatory=$true)][string]$NetworkingRGName,
    [parameter(Mandatory=$true)][string]$RouteTableName
)

$RouteNamePrefix = "UDR-ASE-MGMTGlobal"
$AddressPrefixes = ("13.64.115.203/32","13.66.140.0/32","13.67.8.128/32","13.69.64.128/32","13.69.227.128/32","13.70.73.128/32","13.71.170.64/32","13.71.194.129/32","13.75.34.192/32","13.75.127.117/32","13.77.50.128/32","13.78.109.0/32","13.89.171.0/32","13.94.141.115/32","13.94.143.126/32","13.94.149.179/32","20.36.106.128/32","20.36.114.64/32","23.100.226.236/32","23.102.135.246/32","23.102.188.65/32","40.69.106.128/32","40.70.146.128/32","40.71.13.64/32","40.74.100.64/32","40.78.194.128/32","40.79.130.64/32","40.79.178.128/32","40.83.120.64/32","40.83.121.56/32","40.83.125.161/32","40.90.240.166/32","40.91.126.196/32","40.112.242.192/32","40.119.4.111/32","40.124.47.188/32","51.140.146.64/32","51.140.210.128/32","52.151.25.45/32","52.162.80.89/32","52.162.106.192/32","52.165.152.214/32","52.165.153.122/32","52.165.154.193/32","52.165.158.140/32","52.174.22.21/32","52.178.177.147/32","52.178.184.149/32","52.178.190.65/32","52.178.195.197/32","52.187.56.50/32","52.187.59.251/32","52.187.63.19/32","52.187.63.37/32","52.224.105.172/32","52.225.177.153/32","52.231.18.64/32","52.231.146.128/32","65.52.14.230/32","65.52.172.237/32","65.52.193.203/32","70.37.57.58/32","70.37.89.222/32","104.43.242.137/32","104.44.129.141/32","104.44.129.243/32","104.44.129.255/32","104.44.134.255/32","104.208.54.11/32","104.211.81.64/32","104.211.146.128/32","104.214.49.0/32","157.55.176.93/32","157.55.208.185/32","191.233.203.64/32","191.236.154.88/32")
$i = 1

foreach($AddressPrefix in $AddressPrefixes)
{

    $RouteName = $RouteNamePrefix + '-' + $i
    write-host $RouteName, $AddressPrefix

    Get-AzRouteTable -ResourceGroupName $NetworkingRGName -Name $RouteTableName | Add-AzRouteConfig -Name $RouteName -AddressPrefix $AddressPrefix -NextHopType Internet | Set-AzRouteTable
    $i++
}

########################################################################################################################################################
# The below setting needs to be configured on the ASE via resource explorer before new route table is deployed                                         #
# "userWhitelistedIpRanges": ["40.90.242.118/32", "20.185.99.245/32", "104.45.175.115/32", "40.71.234.123/32", "40.71.234.160/32", "40.71.234.204/32"] #
########################################################################################################################################################
