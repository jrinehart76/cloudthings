{
  "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "sharedServiceSubnetResourceID": {
      "type": "string",
      "defaultValue": "/subscriptions/8a00b99b-04e8-474d-a318-397385dc07a4/resourceGroups/RG-AM-EastUS-Prod-SS/providers/Microsoft.Network/virtualNetworks/VNET-AM-EastUS-Prod-SS/subnets/Subnet-AM-EastUS-Prod-SS-PANUnTrust",
      "metadata": {
        "description": "Range of allowed IPs to access cosmosdb"
      }
    },
    "skuTier": {
      "type": "string",
      "allowedValues": [
        "Basic",
        "GeneralPurpose",
        "MemoryOptimized"
      ],
      "defaultValue": "MemoryOptimized",
      "metadata": {
        "description": "Memory Optimized supported by Gen 5 only"
      }
    },
    "skuCapacity": {
      "type": "int",
      "allowedValues": [
        2,
        4,
        8,
        16,
        32
      ],
      "defaultValue": 4,
      "metadata": {
        "description": "Number of vCores"
      }
    },
    "skuFamily": {
      "type": "string",
      "allowedValues": [
        "Gen4",
        "Gen5"
      ],
      "defaultValue": "Gen5",
      "metadata": {
        "description": "https://docs.microsoft.com/en-us/azure/mysql/concepts-pricing-tiers for regional availability"
      }
    },
    "skuName": {
      "type": "string",
      "allowedValues": [
        "GP_Gen4_2",
        "GP_Gen4_4",
        "GP_Gen4_8",
        "GP_Gen4_16",
        "GP_Gen4_32",
        "GP_Gen5_2",
        "GP_Gen5_4",
        "GP_Gen5_8",
        "GP_Gen5_16",
        "GP_Gen5_32",
        "MO_Gen5_2",
        "MO_Gen5_4",
        "MO_Gen5_8",
        "MO_Gen5_16",
        "MO_Gen5_32"
      ],
      "defaultValue": "MO_Gen5_2",
      "metadata": {
        "description": "Tier + family + cores:  {B/GP/MO}_{Gen4/Gen5}_{2/4/8/16/32}"
      }
    },
    "skuSizeMB": {
      "type": "int",
      "defaultValue": 102400
    },
    "purpose": {
      "type": "string",
      "defaultValue": "data"
    },
    "version": {
      "type": "string",
      "allowedValues": [
        "5.6",
        "5.7"
      ],
      "defaultValue": "5.7"
    },
    "startNumber": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "The starting number of the resources(s) being deployed"
      }
    },
    "numberOfInstances": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "The number of my sql instances you wish to deploy"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "EastUS",
      "metadata": {
        "description": "The Azure region for this deployment"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "Dev",
      "metadata": {
        "description": "The abbreviated environment label"
      }
    },
    "application": {
      "type": "string",
      "defaultValue": "APP",
      "metadata": {
        "description": "The abbreviated application name"
      }
    },
    "region": {
      "type": "string",
      "defaultValue": "AM",
      "metadata": {
        "description": "The abbreviated Azure Region code"
      }
    },
    "mySqlAdminLogin": {
      "type": "string",
      "defaultValue": "sqlAdmin",
      "minLength": 1,
      "maxLength": 16,
      "metadata": {
        "description": "The administrator username for the server"
      }
    },
    "mySqlAdminLoginPassword": {
      "type": "securestring"
    },
    "settingName": {
      "type": "string",
      "defaultValue": "logAnalyticsService",
      "metadata": {
        "description": "Name of the setting. Name for the diagnostic setting resource. Eg. 'archiveToStorage' or 'forSecurityTeam'."
      }
    },
    "userUPN": {
      "type": "string",
      "defaultValue": "APP",
      "metadata": {
        "description": "The Active Directory UPN of the Group or user that will be permitted login"
      }
    },
    "userObjectID": {
      "type": "string",
      "defaultValue": "AM",
      "metadata": {
        "description": "The Azure Active Directory Object ID of the UPN"
      }
    },
    "workspaceName": {
      "type": "string",
      "allowedValues": [
        "laws-am-eastus",
        "laws-ap-southeastasia",
        "laws-eu-uksouth",
        "la-am-eastus-devopspoc"
      ],
      "metadata": {
        "description": "Log Analytics workspace ID for the Log Analytics workspace to which logs will be sent."
      }
    },
    "laResourceGroup": {
      "type": "string",
      "allowedValues": [
        "rg-am-eastus",
        "rg-ap-southeastasia",
        "rg-eu-uksouth",
        "rg-am-eastus-devopspoc-mgmt"

      ],
      "metadata": {
        "description": "The Resource Group where the Log Analytics workspace resides to which logs will be sent."
      }
    },
    "subscriptionID": {
      "type": "string",
      "allowedValues": [
        "0ffde392-0ea6-4c28-b315-92e6417ab377",
        "e99bdf77-771f-4f55-aceb-947a842db84a"
      ],
      "metadata": {
        "description": "The Resource Group where the Log Analytics workspace resides to which logs will be sent."
      }
    }
  },
  "variables": {
    "DBforMySQLapiVersion": "2017-12-01",
    "mySqlServerName": "[tolower(concat('mysql-', parameters('region'), '-', parameters('location'), '-', parameters('environment'), '-', parameters('application'), '-', parameters('purpose'), '-'))]",
    "resourceGroupName": "[concat('rg-', parameters('region'), '-', parameters('location'))]",
    "workspaceId": "[resourceId('0ffde392-0ea6-4c28-b315-92e6417ab377', parameters('laResourceGroup'), 'Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
  },
  "resources": [
    {
      "apiVersion": "[variables('DBforMySQLapiVersion')]",
      "type": "Microsoft.DBforMySQL/servers",
      "location": "[parameters('location')]",
      "name": "[concat(variables('mySqlServerName'),padLeft(copyIndex(parameters('startNumber')),2,'0'))]",
      "copy": {
        "name": "mySqlLoop",
        "count": "[parameters('numberOfInstances')]"
      },
      "sku": {
        "name": "[parameters('skuName')]",
        "tier": "[parameters('skuTier')]",
        "capacity": "[parameters('skuCapacity')]",
        "family": "[parameters('skuFamily')]"
      },
      "properties": {
        "StorageProfile": {
          "storageMB": "[parameters('skuSizeMB')]",
          "backupRetentionDays": 7,
          "geoRedundantBackup": "Disabled"
        },
        "version": "[parameters('version')]",
        "administratorLogin": "[parameters('mySqlAdminLogin')]",
        "administratorLoginPassword": "[parameters('mySqlAdminLoginPassword')]"

      },
      "resources": [
        {
          "type": "Microsoft.DBforMySQL/servers/administrators",
          "apiVersion": "2017-12-01",
          "name": "[concat(variables('mySqlServerName'),padLeft(copyIndex(parameters('startNumber')),2,'0'), '/ActiveDirectory')]",
          "dependsOn": [
            "[concat(variables('mySqlServerName'),padLeft(copyIndex(parameters('startNumber')),2,'0'))]"
          ],
          "properties": {
              "administratorType": "ActiveDirectory",
              "login": "[parameters('userUPN')]",
              "sid": "[parameters('userObjectId')]",
              "tenantId": "0c5638da-d686-4d6a-8df4-e0552c70cb17"
          }
        },
        {
          "type": "virtualnetworkrules",
          "apiVersion": "[variables('DBforMySQLapiVersion')]",
          "dependsOn": [
            "[concat('Microsoft.DBforMySQL/servers/', variables('mySqlServerName'),padLeft(copyIndex(parameters('startNumber')),2,'0'))]"
          ],
          "location": "[parameters('location')]",
          "name": "GCCS-SharedServices-VNet",
          "properties": {
            "ignoreMissingVnetServiceEndpoint": false,
            "virtualNetworkSubnetId": "[parameters('sharedServiceSubnetResourceID')]"
          }
        },
        {
          "type": "providers/diagnosticSettings",
          "name": "Microsoft.Insights/diagnostics",
          "dependsOn": [
            "[concat(variables('mySqlServerName'),padLeft(copyIndex(parameters('startNumber')),2,'0'))]"
          ],
          "apiVersion": "2017-05-01-preview",
          "properties": {
            "name": "[parameters('settingName')]",
            "workspaceId": "[variables('workspaceId')]",
            "logs": [
              {
                "category": "MySqlSlowLogs",
                "enabled": true,
                "retentionPolicy": {
                  "days": 90,
                  "enabled": true
                }
              },
              {
                "category": "MySqlAuditLogs",
                "enabled": true,
                "retentionPolicy": {
                  "days": 90,
                  "enabled": true
                }
              }
            ]
          }
        }
      ]
    }
  ]
}