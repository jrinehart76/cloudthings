{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "EastUS",
      "metadata": {
        "description": "The Azure region for this deployment"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "Dev",
      "metadata": {
        "description": "The abbreviated environment label"
      }
    },
    "application": {
      "type": "string",
      "defaultValue": "APP",
      "metadata": {
        "description": "The abbreviated application name"
      }
    },
    "region": {
      "type": "string",
      "defaultValue": "AM",
      "metadata": {
        "description": "The abbreviated Azure Region code"
      }
    },
    "kubernetesVersion": {
      "type": "string",
      "defaultValue": "1.11.2",
      "metadata": {
        "description": "Cluster Kubernetes Version to deploy"
      }
    },
    "nodeAgentCount": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Default Number of Agent Nodes in the cluster"
      }
    },
    "nodeOSType": {
      "type": "string",
      "defaultValue": "Linux",
      "metadata": {
        "description": "Default OS Type for Agent Nodes in the cluster"
      }
    },
    "nodeSize": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "metadata": {
        "description": "Default VM size for Agent Nodes in the cluster"
      }
    },
    "nodeDiskSizeGB": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "Default VM OS Disk size for Agent Nodes in the cluster. O means the default disk size for a VM SKU"
      }
    },
    "nodestorageProfile": {
      "type": "string",
      "defaultValue": "ManagedDisks",
      "metadata": {
        "description": "VM OS Disk type for Agent Nodes in the cluster."
      }
    },
    "nodeAdminUsername": {
      "type": "string",
      "defaultValue": "cloudadmin",
      "metadata": {
        "description": "VM admin user"
      }
    },
    "nodeSSHPublicKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Configure all linux machines with the SSH public key string.  Your key should include three parts, for example 'ssh-rsa AAAAB...snip...UcyupgH azureuser@linuxvm'"
      }
    },
    "azureServicePrincipalAppId": {
      "type": "string",
      "metadata": {
        "description": "Service Principal App ID (also called Client ID) that has contributor rights to the subscription used for this deployment. It is used by the Kubernetes cluster to dynamically manage resources (e.g. user-defined load balancers)."
      }
    },
    "azureServicePrincipalAppKey": {
      "type": "securestring",
      "metadata": {
        "description": "Service Principal App Key (also called Client Secret) that has contributor rights to the subscription used for this deployment. It is used by the Kubernetes cluster to dynamically manage resources (e.g. user-defined load balancers)."
      }
    },
    "networkPlugin": {
      "type": "string",
      "allowedValues": [
        "kubenet",
        "azure"
      ],
      "defaultValue": "azure",
      "metadata": {
        "description": "IPAM plugin for AKS cluster."
      }
    },
    "serviceCidr": {
      "type": "string",
      "metadata": {
        "description": "IP address range to use for Kubernetes services."
      }
    },
    "dnsServiceIP": {
      "type": "string",
      "metadata": {
        "description": "Single IP address to use for Kubernetes DNS service. Must be within serviceCidr"
      }
    },
    "dockerBridgeCidr": {
      "type": "string",
      "defaultValue": "172.16.0.1/24",
      "metadata": {
        "description": "Single IP address and netmask (CIDR notation) for Docker bridge."
      }
    },
    "existingVnet": {
      "type": "string",
      "defaultValue": "test-vnet02",
      "metadata": {
        "description": "Name of the existing Virtual Network"
      }
    },
    "existingVnetRG": {
      "type": "string",
      "defaultValue": "test-vnet02",
      "metadata": {
        "description": "Resource Group of the existing Virtual Network"
      }
    },
    "existingSubnet": {
      "type": "string",
      "defaultValue": "aks",
      "metadata": {
        "description": "Name of the subnet within the existing Virtual Network that AKS will be deployed to"
      }
    },
    "clientAppID": {
      "type": "string",
      "metadata": {
        "description": "RBAC Client App ID"
      }
    },
    "serverAppID": {
      "type": "string",
      "metadata": {
        "description": "RBAC Server App ID"
      }
    },
    "serverAppSecret": {
      "type": "securestring",
      "metadata": {
        "description": "RBAC Server App Secret"
      }
    },
    "maxPodCount": {
      "type": "int",
      "defaultValue": 10,
      "metadata": {
        "description": "Max pod count"
      }
    },
    "AutoScaleEnabled": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable autoscale = true"
      }
    },
    "AutoScaleMaxCount": {
      "type": "int",
      "defaultValue": 3,
      "metadata": {
        "description": "Auto Scale Max Node Count"
      }
    },
    "AutoScaleMinCount": {
      "type": "int",
      "defaultValue": 6,
      "metadata": {
        "description": "Auto Scale Min Node Count"
      }
    },
    "workspaceName": {
      "type": "string",
      "allowedValues": [
        "laws-am-eastus",
        "laws-ap-southeastasia",
        "laws-eu-uksouth",
        "la-am-eastus-devopspoc"
      ],
      "metadata": {
        "description": "Log Analytics workspace ID for the Log Analytics workspace to which logs will be sent."
      }
    },
    "laResourceGroup": {
      "type": "string",
      "allowedValues": [
        "rg-am-eastus",
        "rg-ap-southeastasia",
        "rg-eu-uksouth",
        "rg-am-eastus-devopspoc-mgmt"

      ],
      "metadata": {
        "description": "The Resource Group where the Log Analytics workspace resides to which logs will be sent."
      }
    }
  },
  "variables": {
    "baseNamePrefix": "[concat(parameters('region'), '-',  parameters('location'), '-', parameters('environment'), '-', parameters('application'))]",
    "tenantId": "[subscription().subscriptionId]",
    "dnsBaseNamePrefix": "[toLower(concat(parameters('region'), '-',  parameters('location'), '-', parameters('environment'), '-', parameters('application')))]",
    "clusterName": "[concat('AKS-', variables('baseNamePrefix'))]",
    "agentPoolName": "[toLower(concat(parameters('environment'),'agtpool'))]",
    "subnetId": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('existingVNetRG'), '/providers/Microsoft.Network/virtualNetworks/', parameters('existingVNet'), '/subnets/', parameters('existingSubnet'))]",
    "networkPlugin": "[parameters('networkPlugin')]",
    "dnsServiceIP": "[parameters('dnsServiceIP')]",
    "serviceCidr": "[parameters('serviceCidr')]",
    "dockerBridgeCidr": "[parameters('dockerBridgeCidr')]",
    "workspaceId": "[resourceId('0ffde392-0ea6-4c28-b315-92e6417ab377', parameters('laResourceGroup'), 'Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
  },
  "resources": [
    {
      "name": "[variables('clusterName')]",
      "type": "Microsoft.ContainerService/managedClusters",
      "apiVersion": "2020-01-01",
      "location": "[parameters('location')]",
      "properties": {
        "dnsPrefix": "[toLower(variables('clusterName'))]",
        "kubernetesVersion": "[parameters('kubernetesVersion')]",
        "agentPoolProfiles": [
          {
            "name": "[variables('agentPoolName')]",
            "count": "[parameters('nodeAgentCount')]",
            "vmSize": "[parameters('nodeSize')]",
            "osDiskSizeGB": "[parameters('nodeDiskSizeGB')]",
            "dnsPrefix": "[variables('dnsBaseNamePrefix')]",
            "storageProfile": "[parameters('nodeStorageProfile')]",
            "maxPods": "[parameters('maxPodCount')]",
            "osType": "[parameters('nodeOSType')]",
            "vnetSubnetID": "[variables('subnetID')]",
            "type": "VirtualMachineScaleSets",
            "maxCount": "[parameters('AutoScaleMaxCount')]",
            "minCount": "[parameters('AutoScaleMinCount')]",
            "enableAutoScaling": "[parameters('AutoScaleEnabled')]"
          }
        ],
        "linuxProfile": {
          "adminUsername": "[parameters('nodeAdminUsername')]",
          "ssh": {
            "publicKeys": [
              {
                "keyData": "[parameters('nodeSSHPublicKey')]"
              }
            ]
          }
        },
        "enableRBAC": true,
        "aadProfile": {
          "clientAppID": "[parameters('clientAppID')]",
          "serverAppID": "[parameters('serverAppID')]",
          "serverAppSecret": "[parameters('serverAppSecret')]",
          "tenantID": "[subscription().tenantId]"
        },
        "servicePrincipalProfile": {
          "clientId": "[parameters('azureServicePrincipalAppID')]",
          "secret": "[parameters('azureServicePrincipalAppKey')]"
        },
        "networkProfile": {
          "networkPlugin": "[variables('networkPlugin')]",
          "serviceCidr": "[variables('serviceCidr')]",
          "dnsServiceIP": "[variables('dnsServiceIP')]",
          "dockerBridgeCidr": "[variables('dockerBridgeCidr')]",
          "loadBalancerSku": "standard",
          "outboundType": "userDefinedRouting"
        },
        "addonProfiles": {
          "omsagent": {
            "enabled": true,
            "config": {
              "logAnalyticsWorkspaceResourceID": "[variables('workspaceId')]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
  }
}